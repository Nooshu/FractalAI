name: Daily Rebuild

on:
  schedule:
    # Run daily at midnight UTC (00:00 UTC every day)
    # Cron format: minute hour day-of-month month day-of-week
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  rebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Only need read access now
    
    steps:
      - name: Trigger Cloudflare Pages deployment via API
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT_NAME: fractalai
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "::warning::Cloudflare API credentials not configured."
            echo "To enable API-triggered rebuilds (without git commits), configure:"
            echo "  - CLOUDFLARE_API_TOKEN (with Pages:Edit permissions)"
            echo "  - CLOUDFLARE_ACCOUNT_ID"
            echo ""
            echo "Note: For Git-connected Cloudflare Pages projects, the API method"
            echo "may not work. Consider using Cloudflare's deployment webhook instead."
            exit 0
          fi
          
          # Attempt to trigger deployment via Cloudflare Pages API
          # Note: This may not work for Git-connected projects - use webhook instead
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"branch": "main"}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… Successfully triggered Cloudflare Pages deployment"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
          else
            echo "::warning::API deployment not available (HTTP $HTTP_CODE)"
            echo "For Git-connected projects, use a deployment webhook instead."
            echo "See: https://developers.cloudflare.com/pages/platform/deployment-webhooks/"
          fi

